syntax = "proto3";

package cel.expr.ai;

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

option java_package = "dev.cel.expr.ai";
option java_multiple_files = true;
option java_outer_classname = "AgentContextProto";

// Agent represents the AI System or Service being governed.
// It encapsulates the static configuration (Manifests, Identity) and the
// dynamic runtime state (Context, Inputs, Outputs).
message Agent {
  // The unique resource name of the agent.
  // e.g. "agents/finance-helper" or "publishers/google/agents/gemini-pro"
  string name = 1;

  // Human-readable description of the agent's purpose.
  string description = 2;

  // The semantic version of the agent definition.
  string version = 3;

  // The underlying model family backing this agent.
  Model model = 4;

  // The provider or vendor responsible for hosting/managing this agent.
  AgentProvider provider = 5;

  // Identity of the Agent itself (Service Account / Principal)
  // Independent of 'request.auth.principal' which may be the end user
  // credentials or the agent's identity
  AgentAuth auth = 6;

  // The accumulated security context (Trust, Sensitivity, Data Sources).
  AgentContext context = 7;

  // The current turn's input (Prompt + Attachments)
  AgentMessage input = 8;

  // The pending response (if evaluating egress/output policies)
  AgentMessage output = 9;
}

// AgentAuth represents the identity of the Agent itself.
// Independent of 'request.auth.principal' which may be the end user
// credentials or the agent's identity
message AgentAuth {
  // The principal of the agent, prefer SPIFFE format of:
  // spiffe://<trust-domain>/ns/<project>/sa/<account>
  // See: https://spiffe.io/docs/latest/spiffe/concepts/#spiffe-identifiers
  string principal = 1;

  // Map of string keys to structured claims about the agent.
  // For example, with JWT-based tokens, the claims would include fields
  // indicating the following:
  //
  // - The issuer 'iss' (e.g. url of the identity provider)
  // - The audience(s) 'aud' (e.g. the intended recipient(s) of the token)
  // - The token's expiration time ('exp')
  // - The token's subject ('sub')
  google.protobuf.Struct claims = 2;

  // The OAuth scopes granted to the agent.
  // This is a list of strings, where each string is a valid OAuth scope
  // (e.g. "https://www.googleapis.com/auth/cloud-platform").
  repeated string oauth_scopes = 3;
}

// AgentContext represents the aggregate security and data governance state
// of the agent's context window.
message AgentContext {
  // Aggregated view of data sensitivity in the window.
  repeated Sensitivity sensitivities = 1;

  // Aggregated trust score (Min of all inputs).
  Trust trust = 2;

  // Origin/Lineage tracking.
  repeated DataSource data_sources = 3;

  // The flattened text content of the current prompt.
  string prompt = 4;
}

// AgentHistory represents the ordered sequence of messages representing the
// agent's conversation.
//
// AgentHistory is expected to be provided on-demand via helper methods
// associated with an Agent instance.
message AgentHistory {
  // The name of the agent for whom this history is collected.
  //
  // This should match the `Agent.name` field.
  string agent_name = 1;

  // The ordered sequence of messages representing the agent's conversation.
  repeated AgentMessage messages = 2;
}

// AgentMessage represents a single turn in the conversation.
// It acts as a container for multimodal content (Text, Files, Tool Results).
message AgentMessage {
  // A discrete unit of content within the message.
  message Part {
    oneof type {
      // User or System text input.
      ContentPart prompt = 1;

      // A request to execute a specific tool.
      //
      // If a call has been completed, the call will have the result or
      // error populated. Calls which have not yet been resolved will only have
      // the intent (arguments) populated.
      ToolCall tool_call = 2;

      // A file or multimodal object (Image, PDF).
      ContentPart attachment = 3;

      // An error that occurred during processing.
      ErrorPart error = 4;
    }
  }

  // The actor who constructed the message (e.g., "user", "model", "tool").
  string role = 1;

  // The ordered sequence of content parts.
  //
  // In the case of a tool call, the result or error will be populated within
  // the `ToolCall` message rather than split into a separate `Part`.
  repeated Part parts = 2;

  // Arbitrary metadata associated with the message turn.
  optional google.protobuf.Struct metadata = 3;

  // Message creation time
  google.protobuf.Timestamp time = 4;
}

// ContentPart is a catch-all message type capable of encapsulating other
// messages within its `structured_content` field.
//
// For example, a series of sub-agent MCP tool calls and results may be
// encapsulated as an `AgentMessage` in JSON form within the
// `structured_content` field.
//
// The approach is unconventional, but indicates how the data representation
// provided to policy requires helper methods to help make agent policies
// sensible and with support to type-convert from json to proto perhaps being
// a necessary on-demand feature within agent policies.
message ContentPart {
  // Unique identifier for this content part.
  string id = 1;

  // The type of content.
  //
  // Common values include: "text", "file", "json"
  string type = 2;

  // The MIME type of the content.
  //
  // Common values include: "text/plain", "application/json", "image/png"
  string mime_type = 3;

  // The name of the content.
  string name = 4;

  // The description of the content.
  string description = 5;

  // The URI of the content.
  optional string uri = 6;

  // The string seriralized representation of the content, either plain text or
  // serialized JSON reflected from `structured_content`.
  optional string content = 7;

  // The binary representation of the content.
  //
  // This field is used to represent binary data (e.g., images, PDFs) or
  // serialized proto messages which come over the wire as base64-encoded string
  // values that are expected to be decoded into binary data.
  optional bytes data = 8;

  // The JSON object representation of the content, if applicable.
  optional google.protobuf.Struct structured_content = 9;

  // Arbitrary metadata associated with the content part.
  optional google.protobuf.Struct annotations = 10;

  // Timestamp associated with the content part.
  google.protobuf.Timestamp time = 11;
}

// ErrorPart represents a processing error within the agent loop.
message ErrorPart {
  // The identifier of the specific ContentPart, ToolCall, or Message that
  // caused this error. Used to correlate the failure back to the originating
  // action (e.g., matching a failed tool call).
  string id = 1;

  // Standardized error code (e.g., gRPC status code or HTTP status).
  int64 code = 2;

  // Developer-facing error message describing the failure.
  string error_message = 3;

  // Timestamp when the error occurred.
  google.protobuf.Timestamp time = 4;
}

// AgentProvider describes the entity responsible for the agent's operation.
message AgentProvider {
  // The base URL or endpoint where the agent service is hosted.
  string url = 1;

  // The name of the organization providing the agent (e.g. "Google",
  // "Salesforce").
  optional string organization = 2;
}

// Model describes the AI model backing the agent.
message Model {
  // Identifier of the model family (ex: gemini-pro, gpt-4 ...)
  string name = 1;
}

// ToolManifest describes a collection of tools provided by a specific
// source.
message ToolManifest {
  // Metadata about the tool provider itself, including authorization
  // requirements.
  ToolProvider provider = 1;

  // Collection of Tool instances specified by the provider.
  repeated Tool tools = 2;
}

// Tool describes a specific function or capability available to the agent.
message Tool {
  // The unique name of the tool
  string name = 1;  // (e.g. "weather_lookup").

  // Human readable description of what the tool does.
  string description = 2;

  // JSON Schema defining the expected arguments.
  optional google.protobuf.Struct input_schema = 3;

  // JSON Schema defining the expected output.
  optional google.protobuf.Struct output_schema = 4;

  // Security and behavior hints for policy enforcement.
  optional ToolAnnotations annotations = 5;

  // Arbitrary tool metadata.
  optional google.protobuf.Struct metadata = 6;
}

// Information about how the tools were provided and by whom.
message ToolProvider {
  // URL where the tools were provided.
  string url = 1;

  // Name of the tool provider.
  string organization = 2;  // e.g. "google-cloud"

  // URL for the OAuth authorization endpoint supported by this tool provider
  optional string authorization_server_url = 3;

  // Repeated set of OAuth scopes for this tool provider.
  repeated string supported_scopes = 4;
}

// Additional properties describing a tool to clients.
//
// Informed by annotations common to the MCP spec and conventions common to
// other agent frameworks.
message ToolAnnotations {
  // A human-readable title for the tool.
  string title = 1;

  // If true, the tool does not modify its environment.
  // Default: false
  bool read_only = 2;

  // If true, the tool may perform destructive updates to its environment.
  // If false, the tool performs only additive updates.
  // NOTE: This property is meaningful only when `read_only_hint == false`
  bool destructive = 3;

  // If true, calling the tool repeatedly with the same arguments will have no
  // additional effect on its environment.
  // NOTE: This property is meaningful only when `read_only_hint == false`.
  bool idempotent = 4;

  // If true, this tool may interact with an "open world" of external entities.
  // If false, the tools domain of interaction is closed. For example, the
  // world of a web search tool is open, whereas that of a memory tool is not.
  bool open_world = 5;

  // If true, this tool is intended to be called asynchronously.
  // For example, a tool that starts a simulation process on a server and
  // returns immediately.
  bool async = 6;

  // Additional structured tags associated with the tool.
  map<string, google.protobuf.Struct> tags = 7;

  // The OAuth scopes required to use this tool. If empty, the set of scopes
  // required is inherited from ToolProvider.supported_scopes.
  //
  // This is a list of strings, where each string is a valid OAuth scope
  // (e.g. "https://www.googleapis.com/auth/cloud-platform").
  repeated string required_auth_scopes = 8;

  // The OAuth scopes that are optional to use this tool.
  repeated string optional_auth_scopes = 9;

  message DataAccessLevel {
    Sensitivity sensitivity = 1;

    message AccessRole {
      string role = 1;
      google.protobuf.Struct metadata = 2;
    }
  }
}

// Sensitivity describes the classification of data within the context.
message Sensitivity {
  // Valid labels are 'pii', 'internal'
  string label = 1;

  // The optional value associated with the label, e.g. 'credit card'
  string value = 2;
}

// Describes the integrity/veracity of the data.
message Trust {
  // Valid trust labels are "untrusted" (default), "trusted", and
  // "partially_trusted".
  string label = 1;
}

// Describes the provenance of a data chunk.
message DataSource {
  // Unique id describing the originating data source.
  string id = 1;  // e.g. "bigquery:sales_table"

  // The category of origin for this data.
  string provenance = 2;  // e.g. "UserPrompt", "Database:Secure", "PublicWeb"
}

// ToolCall represents a specific invocation of a tool by the agent.
// It captures the intent (arguments), the status (result/error), and
// governance metadata (confirmation).
message ToolCall {
  // Unique identifier for this tool call.
  // Used to correlate the call with its result or error in the history.
  string id = 1;

  // The name of the tool being called (e.g., "weather_lookup").
  // This should match a tool defined in the agent's ToolManifest.
  string name = 2;

  // The arguments provided to the tool call.
  // Policies can inspect these values to enforce data safety (e.g. no PII).
  google.protobuf.Struct arguments = 3;

  // The execution status of the tool call.
  // This field is populated if the tool has already been executed (in history).
  oneof status {
    // The successful output of the tool.
    ContentPart result = 4;

    // The error encountered during execution.
    ErrorPart error = 5;
  }

  // Timestamp when the tool call was initiated.
  google.protobuf.Timestamp time = 6;

  // Indicates if the user explicitly confirmed this action.
  // Useful for Human-in-the-Loop (HITL) policies.
  bool user_confirmed = 7;
}