name: "policy.two.models.contextual"
default: allow

variables:
  - trusted_plan: >
      security.computePrivilegedPlan(
        ctx.agent.context.history.filter(msg, msg.metadata.trust_level == 'TRUSTED')
      )

rules:
  - description: "Enforce the privileged plan: Deny unauthorized tools"
    condition: |
      tool.name != "" &&
      variables.trusted_plan.size() > 0 &&
      !(tool.name in variables.trusted_plan)
    effect: deny
    message: "Tool call violated the privileged execution plan. This tool is not authorized for this context."

  - description: "Enforce the privileged plan: Allow authorized tools"
    condition: |
      tool.name != "" &&
      variables.trusted_plan.size() > 0 &&
      (tool.name in variables.trusted_plan)
    effect: allow
    message: ""

#   - description: "Establish the privileged plan"
#     condition: variables.trusted_plan.size() > 0
#     effect: restrict_tools
#     output_expr: |
#       {'allowed_agents': variables.trusted_plan}
